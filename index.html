<!DOCTYPE html>
<html>
<head>
  <title>GitHub Deploy Tool</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; padding: 2em; }
    input, button, textarea { width: 100%; padding: 0.5em; margin: 0.2em 0; background: #222; color: #fff; border: 1px solid #444; }
    code { background: #222; padding: 0.5em; display: block; margin-top: 1em; white-space: pre-wrap; }
    a { color: #0f0; text-decoration: underline; }
  </style>
</head>
<body>
  <h1>🔁 GitHub Deploy Tool (Pages)</h1>
  <input id="token" placeholder="GitHub Token (PAT)">
  <input id="owner" placeholder="GitHub gebruiker">
  <input id="repo" placeholder="Repository naam">
  <textarea id="html" placeholder="HTML content voor index.html" rows="10"></textarea>
  <button onclick="deploy()">🚀 Deploy naar gh-pages</button>

  <code id="log">Wacht op input...</code>

  <script>
    async function deploy() {
      const token = document.getElementById('token').value.trim();
      const owner = document.getElementById('owner').value.trim();
      const repo = document.getElementById('repo').value.trim();
      const html = document.getElementById('html').value.trim();
      const log = document.getElementById('log');
      const content = btoa(unescape(encodeURIComponent(html)));
      const path = 'index.html';
      const branch = 'gh-pages';
      const headers = {
        Authorization: `token ${token}`,
        Accept: 'application/vnd.github.v3+json'
      };

      log.textContent = '🔍 Controleren of branch bestaat...';

      try {
        const refRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/ref/heads/${branch}`, { headers });
        if (!refRes.ok) {
          const main = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/ref/heads/main`, { headers }).then(r => r.json());
          await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs`, {
            method: 'POST',
            headers,
            body: JSON.stringify({ ref: `refs/heads/${branch}`, sha: main.object.sha })
          });
        }
      } catch {}

      log.textContent = '📄 Controleren of index.html al bestaat...';

      let sha = null;
      try {
        const fileRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers });
        if (fileRes.ok) {
          const fileData = await fileRes.json();
          sha = fileData.sha;
        }
      } catch {}

      log.textContent = '📤 Uploaden van index.html...';

      const upload = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers,
        body: JSON.stringify({
          message: 'Deploy via dashboard',
          content: content,
          branch: branch,
          ...(sha ? { sha } : {})
        })
      });

      const result = await upload.json();

      if (!upload.ok) {
        log.textContent = `❌ Fout:\n${JSON.stringify(result, null, 2)}`;
        return;
      }

      const url = `https://${owner}.github.io/${repo}/`;
      log.textContent = `✅ Upload gelukt.\n⏳ Wachten tot nieuwe versie live staat...`;

      // Wachten tot nieuwe versie zichtbaar is
      const decodedHTML = decodeURIComponent(escape(atob(content)));
      let tries = 0;

      const checkOnline = setInterval(async () => {
        try {
          const res = await fetch(url + '?t=' + Date.now(), { cache: "no-store" });
          const text = await res.text();
          if (res.ok && text.trim() === decodedHTML.trim()) {
            clearInterval(checkOnline);
            log.innerHTML = `✅ Nieuwe versie is online!\n👉 <a href="${url}" target="_blank">${url}</a>`;
          } else if (++tries > 30) {
            clearInterval(checkOnline);
            log.textContent = '⚠️ Site blijft oude versie tonen (na 30s).';
          }
        } catch {
          if (++tries > 30) {
            clearInterval(checkOnline);
            log.textContent = '⚠️ Site onbereikbaar (na 30s).';
          }
        }
      }, 1000);
    }
  </script>
</body>
</html>